var fs = require('fs');
var audioMetaData = require('audio-metadata');



var readdir = function(dir,callback){
    var obj = {
        folder : dir,
        files : []
    };
    fs.readdir(dir,function(err,list){
        if(err){
             callback(err);
        }
        var pending = list.length;
        if(!pending){

            return callback(obj);
        }

        list.forEach(function(file){
            fs.stat(dir + '/' + file,function(err,stat){
                if(stat && stat.isDirectory()){

                //Create folder object
                readdir(dir + '/' + file,function(err,res){
                    obj.files.push(res);
                     if (!--pending){
                        callback(null,obj);
                     }
                });
                } else {

                    //Create file data object
                    var fileName = file.substr(file.lastIndexOf('/') + 1);
                    var fileExtension = fileName.split('.').pop();
                    var stats = fs.statSync(dir + '/' + file);
                    var fileSizeInBytes = stats["size"];
                    var fileSizeInMegabytes = fileSizeInBytes / 1000000.0;
                    obj.files.push({
                        "filePath": dir + '/' + file,
                        "filename":fileName,
                        "fileExtension": fileExtension,
                        "fileSize" : fileSizeInMegabytes,
                        "metadata" : null
                    });
                    if (!--pending){
                        callback(null,obj);
                     }
                }
            });
        });
    });
};






module.exports = readdir;
